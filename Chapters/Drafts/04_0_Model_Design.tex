\chapter{Model Design}
% Muscle Selection and Modelling
Spasticity (velocity-dependent stiffness) in stroke typically produces resistance to arm extension due to overactivity of biceps, wrists and finger flexors and loss of activity of triceps, anterior deltoid, wrist and finger extensors (reference 24). \cite{IOL}
Triceps and anterior deltoid are hence selected for stimulation to align with the clinical need to increase muscle tone and restore motor control of weakened muscles. 
The relationship between muscle stimulation adn subsequent movement are well explored. However, simplification opens up routes for both aprameter identification and controller derivation that have not yet been possible for more complex models. \cite{IOL}
It is assumed that applying FES to the anterior deltoid produces a moment about an axis that is fixed with respect to the shoulder. Applying FES to the triceps produces a moment about an axis orthogonal to both the forearm and upper arm.\cite{IOL}

As discussed in [26] the most prevalent form of muscle representation is the Hill-type muscle. (Explain the Hill-Type muscle)
% FES deviced used
Functional Electrical Stimulator (a DSP-based FES) was developed in our laboratory. 23,35,50Hz are available ofr the pulse frequency. 
The pulse width ranges from 0 to 300 $\mu$s. The output current is from 0 to 100 mA. The stimulation wave can be modified into two models: single phase, and biphasic phase. \cite{NNPID}



% Problems
Referring to the past literature, no one has been able to solve the transfer functions for mucles and bone systems. We obtained better values in this experiment with continuous testing. The stability results were greatly influenced if the Kp, Ki and Kd parameters in the PID controller were adjusted. \cite{NNPID}

Achieving reaching motions with FES has proven difficult due to complexity. The goal-directed nature of reaching motions, requires different and new simulation patterns for every reach. Many different control strategies have been proposed (summary of control strategies). To accurately control reaching motions, it is necessary to treat the arm as a complete system. 




A more sophisticated controllers is needed for our upper extremity FES system, because unlike the cyclic movemenf ot the lower, upper-extremity tasks are goal directed. This means that the amplitude, speed adn direction of the motions change continuously, so the controller need to continuously calculate the stimulation patterns for a wide range of motions commanded by the user. \cite{CFF}. 
% General Idea
Veltnik and Chizeck et al. described the muscle output torque relation to the input stimulation and joint angle using a muscle model that include the muscle activation. They designed a nonlinear open-loop compensator and controlled the joint angle using a PID feedback controller. \cite{NNPID}



%% Control Method
% Feedforward
There are different control strategies used in existing FES systems. Feedforward control is commonly used in clinical practice (13,15). The output of this type of controller depends only on the user command, and not on the system performance. The advantage of this design is that it does need sesnros to measure the system output, but the disadvante is that it is unable to make corrections it he actual movmeent deviates from the desired movement. \cite{CFF}

% Feedback
Feedback control usess sensors to monitor output, so it can correct for errors in the system trajectory. Feedback is necessary in order to maintain good tracking performance in the rpesence of fatigue and any external distrubances encountered. However, inherent delays in the response of the system can cause problem to the feedback controller, especially in the case of fast movements. \cite{CFF}

Therefore a combination of feedforward and feedback control has the best results, and is the preferred control method in several FES system designs. 

The feedfoward is typically an inverse-dynamic model of the controlled system. Train an ANN to behave like the inverse-dynamic model. An ANN that includes time-delayed inputs can approximate any dynamic systems based solely on the knowledge of inputs and ouputs.

% Neural Network Control
Develop a non-modeling control controlling method. The neural network control theory is just one method to this approach.\cite{NNPID}.

Controller system. The 3-level network structure uses back-propagation. The NN was used to evaluate the stimulation current. The PID controller part was used to fine-tune the current. Supervised learning neural network. The network was designed to find the input/output coincidence relations with minimum error using a back propagation algorithm. The network controllers is trained by the NN before patient applications are begun. Only after training, the network controller can be applied to the control system. \cite{NNPID}

The designed electrical stimulating current signals are used to stimulate the patient´s foot. The changing ankle joint angle value is measured. It is given as an input to the neural network. A relation between the stimulating current and the the ankle joint angle is established. The supervised learning method and back-propagation algorithm were used to inversely implement the learning modifications. Backward error propagation \cite{NNPID}.

% Iterative Learning Control
Iterative Learning Control (ILC) is another leading appraoch, and has exploited the repetitive nature of the rehabilitation process, where patients attempt the same task multiple times to promote relearning. ILC sequentially improves accuracy using fata from previous attempts to adjust the FES supplied during the next execution of the tasks, and has been succesfully used by several groups to assist movement in the lower limb (additional references) \cite{IOL}.

The ILC structura has minimial parameters that can be tuned to compromise performance and robustness in an intuitive manner, including stipulation of convergence and trial-to-trial control effort. When combined with input-output linearization these properties can be set for each joint independently, and hence generalize to arbitrary DOF. \cite{IOL}

ILC is applicable to systems which repeatedly track a fixed reference signal over a finite time interval, termed a trial. 
After each trial, the system is reset to the same initial condidition, and previous trial data are used to modify the control input ot reduce the error in the subsequent trial. ILC is often applied in combination with a feedback controller to ensure disturbance rejection and baseline tracking perforamnce. All ILC systems are subject o iteration varying disturbance and modeling uncertainty. The effects of model uncerstainty results in the input-output linearization action producing a system that does not equate to G(s). 



\subsection{Design}
A two-part model is developed.
\begin{itemize}
    \item Inverse statics. From arm configuration it maps the joint torque needed to to hold the desired configuration.
    \item Muscle torque production. From arm configuration and muscle activation it outputs the joint torque produced. 
\end{itemize}

\subsubsection{Target positions and Initial Configuration}
In the paper \cite{QSC} they followed the same procedure as their laboratory study and they gathered data for the model where the robot held the wrist of the arm in 27 different position. As mentioned in the criteria to gather data for this project, the initial position is the equilibrium position as it is assumed that the stroke survivor presents enough mobility to perform a minimum reaching movement. 

first the model is initialized.
A grid of target points is created using the create\_grid function.
This function will automatically generate a grid of points with the following start
and end position for x y and z. If the model is provided as an input the code will 
plot this points. This serves as a check point to make sure the correct target points
are being generated.


\subsubsection{Static and Excited PI Force Controller}
Two simulations are done one for static force simulation. The objective is to calculate the force required for the robot controller to hold the wrist at a static position. A PID controller is used to apply force at the wrist to mimic the robot. 

The code loop for each position and will calculate the force needed to maintain the arm
in that static position. All the calculations will start using the equilibrium position.
This is because it is assumed that the user will be able to perform most of the movements
by themselves. The equilibrium position is initialized using the initialize\_state function.

The simulation parameters are the following. Tend = 3 and the time step is equal to 0.001.
The torques of the arm is calculated throughout the process.

A PI controller is used to modify the input of the hand force as the arm moves.
The jacobian is calculated to analyse the variation of the hand with time. For that the 
function pos\_jacobian is used. 
The handF = K*error\_pos + I*error\_int;

The force needed to achieve that point is calculate using the last 10% of the data during
the simulation.

The following data is saved for each point.
- xout
- forces
- mean force
- arm config (qtH plus the elbow pronation and supination)
- x (the full 11 dof configuration for the static point)

The same procedure is done but stimulation starting the arm in the end configuration
and then stimulation one of the 3 muscles chosen.

The key is to that the PI controller is always tryingt ot hold hte hand static. So as you turn on a set of muscles, the muscles will move the arm away from the starting position. THe PI will adjuts to hold the hand at the starting position. 

\subsubsection{Kinematic Jacobian}
The kinematic Jacobian is used to transform the recorded robot controller force to the joint torque, $\tau_j$, about the shoulder and elbow which produce the equivalent force. (j represents the muscle group being activated with 0 representing no muscles being active).

The torques needed to hold the wrist in a static position, $p(q) \epsilon R^{4x1}$. The torque about elbow pronation is not included as it does not affect the position of the wrist. With no muscles activated represent the arm statics, and therefore, 

\begin{equation}
    \tau_0 = p(q)
\end{equation}

The difference between the torques recorded with no muscles active and the torques recorded with muscle group j active represents the amount of torque produced by muscle group j. The amount of torque produced by a muscle being activated is represented by $R(q)\alpha$ where $\alpha \epsilon R^{9x1}$ is the vector of muscle group activations and $R(q) \epsilon R^{4x9}$ is the mapping from muscle group activation to joint torque. $R(q)$ is the linear mapping from the vector of muscles activations to the resulting shoulder and elbow torques. Each column of $R(x)$ represents the amount of torque produced by each muscle groups at 100\% activation. The individual muscle torques add linearly if there is no current spillover to adjacent muscles and there no interaction of connective tissue between muscles. This linearity assumption is approximately true due to experiments performed in the human subject \cite{SPI}. It is assumed that torque scales linearly with activation. 

\begin{equation}
    R_j(q) = \tau_0 - \tau_j
\end{equation}

The data for the set of 64 training positions is used to train semiparametric GPR models which are used to predict $\tau_j$ for a given configuration. The models are used to determine the static arm torques $p(q)$ and the muscle force mapping $R(q)$ for a desired arm configuration.

\subsubsection{GPR}

The data for the set of 64 training positions is used to train semiparametric GPR models which are used to predict $\tau_j$ for a given configuration. The models are used to determine the static arm torques $p(q)$ and the muscle force mapping $R(q)$ for a desired arm configuration.

The input to the GPR model are the arm configuration and the output are the torques generated. One GPR model was used for the inverse statics and the other one for the muscle torque production. 
Relative to a parametric model, GPR does not have requirement on identifiability. Compared to other nonparametric methods, such as ANN, GPR is chosen due to the automated nature of determined the complexity of th emodel by maximizing the marginal likelihood (see \cite{SPI} for details on the quality of the model). The hyper-parameters for each model were selected by maximing the marginal likelihood. The kerned function used in the GPR was the squared exponential function using the distance metric for rigid bodies. 

The method uses GPR to predict shoulder and elbow torques given the shoulder and elbow joint positions and velocities and the electrical stimulation inputs to muscles. There was a comparison of accuracy between nonparametric, semiparametric and parametric model types. The most accurate of the three model types is a semiparametric GP model that combines the flexibility if a black box function approximation with the generalization power of a parametrized model. \cite{SPI}. The semiparametric model predicted torques during stimulation of multiple muscles with error less than 20\% of the total muscle torque and passive torque neede to drive the arm. The identified model allows to define an arbitrary reaching trajectory and approximately determinet the muscle stimulation required to drive the arm along the trajectory. 


\section{Control Design}
\subsection{Background}
Achieving reaching motions with FES has proven difficult due to complexity. The goal-directed nature of reaching motions, requires different and new simulation patterns for every reach. Many different control strategies have been proposed (summary of control strategies). To accurately control reaching motions, it is necessary to treat the arm as a complete system. 




A more sophisticated controllers is needed for our upper extremity FES system, because unlike the cyclic movemenf ot the lower, upper-extremity tasks are goal directed. This means that the amplitude, speed adn direction of the motions change continuously, so the controller need to continuously calculate the stimulation patterns for a wide range of motions commanded by the user. \cite{CFF}. 
% General Idea
Veltnik and Chizeck et al. described the muscle output torque relation to the input stimulation and joint angle using a muscle model that include the muscle activation. They designed a nonlinear open-loop compensator and controlled the joint angle using a PID feedback controller. \cite{NNPID}



%% Control Method
% Feedforward
There are different control strategies used in existing FES systems. Feedforward control is commonly used in clinical practice (13,15). The output of this type of controller depends only on the user command, and not on the system performance. The advantage of this design is that it does need sesnros to measure the system output, but the disadvante is that it is unable to make corrections it he actual movmeent deviates from the desired movement. \cite{CFF}

% Feedback
Feedback control usess sensors to monitor output, so it can correct for errors in the system trajectory. Feedback is necessary in order to maintain good tracking performance in the rpesence of fatigue and any external distrubances encountered. However, inherent delays in the response of the system can cause problem to the feedback controller, especially in the case of fast movements. \cite{CFF}

Therefore a combination of feedforward and feedback control has the best results, and is the preferred control method in several FES system designs. 

The feedfoward is typically an inverse-dynamic model of the controlled system. Train an ANN to behave like the inverse-dynamic model. An ANN that includes time-delayed inputs can approximate any dynamic systems based solely on the knowledge of inputs and ouputs.

% Neural Network Control
Develop a non-modeling control controlling method. The neural network control theory is just one method to this approach.\cite{NNPID}.

Controller system. The 3-level network structure uses back-propagation. The NN was used to evaluate the stimulation current. The PID controller part was used to fine-tune the current. Supervised learning neural network. The network was designed to find the input/output coincidence relations with minimum error using a back propagation algorithm. The network controllers is trained by the NN before patient applications are begun. Only after training, the network controller can be applied to the control system. \cite{NNPID}

The designed electrical stimulating current signals are used to stimulate the patient´s foot. The changing ankle joint angle value is measured. It is given as an input to the neural network. A relation between the stimulating current and the the ankle joint angle is established. The supervised learning method and back-propagation algorithm were used to inversely implement the learning modifications. Backward error propagation \cite{NNPID}.

% Iterative Learning Control
Iterative Learning Control (ILC) is another leading appraoch, and has exploited the repetitive nature of the rehabilitation process, where patients attempt the same task multiple times to promote relearning. ILC sequentially improves accuracy using fata from previous attempts to adjust the FES supplied during the next execution of the tasks, and has been succesfully used by several groups to assist movement in the lower limb (additional references) \cite{IOL}.

The ILC structura has minimial parameters that can be tuned to compromise performance and robustness in an intuitive manner, including stipulation of convergence and trial-to-trial control effort. When combined with input-output linearization these properties can be set for each joint independently, and hence generalize to arbitrary DOF. \cite{IOL}

ILC is applicable to systems which repeatedly track a fixed reference signal over a finite time interval, termed a trial. 
After each trial, the system is reset to the same initial condidition, and previous trial data are used to modify the control input ot reduce the error in the subsequent trial. ILC is often applied in combination with a feedback controller to ensure disturbance rejection and baseline tracking perforamnce. All ILC systems are subject o iteration varying disturbance and modeling uncertainty. The effects of model uncerstainty results in the input-output linearization action producing a system that does not equate to G(s). 




It is difficult to establish the control parameters for these systems and new parameters must be reestablished for each subject. The parameters are not always the same even for the same subject under different circumstances. The traditional control theory, which first requests a mathematical model for the controlled system, is not applicable. \cite{NNPID}.

\subsection{Control Design}
